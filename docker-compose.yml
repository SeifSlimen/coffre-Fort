services:
  # ---------------------------
  # 1) MAYAN DATABASE (OPTIMIZED FOR PERFORMANCE)
  # ---------------------------
  postgres:
    image: postgres:15-alpine
    container_name: coffre-fort-postgres
    deploy:
      resources:
        limits:
          memory: 256M
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-mayan}
      POSTGRES_USER: ${POSTGRES_USER:-mayan}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      # PostgreSQL performance tuning
      POSTGRES_INITDB_ARGS: "--data-checksums"
    command: >
      postgres -c shared_buffers=128MB -c effective_cache_size=192MB -c maintenance_work_mem=32MB -c checkpoint_completion_target=0.9 -c wal_buffers=4MB -c default_statistics_target=100 -c random_page_cost=1.1 -c effective_io_concurrency=200 -c work_mem=2MB -c min_wal_size=1GB -c max_wal_size=4GB -c max_connections=100 -c logging_collector=off
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - coffre-fort-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U mayan" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------
  # 2) REDIS (OPTIMIZED FOR PERFORMANCE)
  # ---------------------------
  redis:
    image: redis:7-alpine
    container_name: coffre-fort-redis
    deploy:
      resources:
        limits:
          memory: 256M
    command: redis-server --maxmemory 200mb --maxmemory-policy allkeys-lru --save 900 1 300 10 60 10000 --appendonly yes --appendfsync everysec
    volumes:
      - redis_data:/data
    networks:
      - coffre-fort-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  # ---------------------------
  # 3) MAYAN WEB SERVICE (optimized for development)
  # Uses internal workers - no separate worker containers needed
  # ---------------------------
  mayan:
    image: mayanedms/mayanedms
    container_name: coffre-fort-mayan
    deploy:
      resources:
        limits:
          memory: 2G  # Stable: concurrency=1 per worker = ~1.5GB usage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      keycloak:
        condition: service_started
    environment:
      MAYAN_DATABASE_ENGINE: django.db.backends.postgresql
      MAYAN_DATABASE_NAME: ${POSTGRES_DB:-mayan}
      MAYAN_DATABASE_USER: ${POSTGRES_USER:-mayan}
      MAYAN_DATABASE_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      MAYAN_DATABASE_HOST: postgres
      # Enable internal workers (no separate worker containers needed)
      MAYAN_WORKER_ENABLE: "True"

      MAYAN_CELERY_BROKER_URL: redis://redis:6379/0
      MAYAN_CELERY_RESULT_BACKEND: redis://redis:6379/0

      # ============================================================
      # WORKER CONCURRENCY SETTINGS
      # ============================================================
      # STABLE/DEV: concurrency=1 per worker = ~5 processes = ~1.5GB RAM
      # PRODUCTION: concurrency=4 per worker = ~20 processes = ~5GB RAM (set mem_limit: 6G)
      # ============================================================
      MAYAN_WORKER_A_CONCURRENCY: 1  # converter, events_fast
      MAYAN_WORKER_B_CONCURRENCY: 1  # documents, indexing, parsing
      MAYAN_WORKER_C_CONCURRENCY: 1  # periodic tasks, exports
      MAYAN_WORKER_D_CONCURRENCY: 1  # OCR, file_metadata
      MAYAN_WORKER_E_CONCURRENCY: 1  # search
      MAYAN_GUNICORN_WORKERS: 2      # web server workers
      # --- PRODUCTION: Uncomment below, comment above, set mem_limit: 6G ---
      # MAYAN_WORKER_A_CONCURRENCY: 4
      # MAYAN_WORKER_B_CONCURRENCY: 4
      # MAYAN_WORKER_C_CONCURRENCY: 4
      # MAYAN_WORKER_D_CONCURRENCY: 4
      # MAYAN_WORKER_E_CONCURRENCY: 4
      # MAYAN_GUNICORN_WORKERS: 3

      # Performance optimizations
      MAYAN_CELERY_WORKER_PREFETCH_MULTIPLIER: 2
      MAYAN_CELERY_TASK_ALWAYS_EAGER: "false"
      MAYAN_CELERY_TASK_EAGER_PROPAGATES: "true"
      MAYAN_DATABASES_CONN_MAX_AGE: 300

      # Admin credentials from .env
      MAYAN_AUTOADMIN_USERNAME: ${MAYAN_AUTOADMIN_USERNAME:-admin}
      MAYAN_AUTOADMIN_PASSWORD: ${MAYAN_AUTOADMIN_PASSWORD:?MAYAN_AUTOADMIN_PASSWORD is required}
      MAYAN_AUTOADMIN_EMAIL: ${MAYAN_AUTOADMIN_EMAIL:-admin@example.com}

      # Explicitly enable automatic OCR
      MAYAN_DOCUMENTS_OCR_AUTO_OCR: "true"

      # Disable GPG/Signatures apps (fixes BrokenPipeError with PNG files)
      MAYAN_COMMON_DISABLED_APPS: "mayan.apps.django_gpg,mayan.apps.document_signatures,mayan.apps.signature_captures"

      # SSO Configuration - Keycloak OIDC (RE-ENABLED)
      # Fixed: No longer overriding AUTHENTICATION_BACKENDS to avoid maximum_session_length error
      MAYAN_SETTINGS_MODULE: "mayan_custom.settings.user_settings"
      OIDC_RP_CLIENT_ID: ${OIDC_RP_CLIENT_ID:-mayan-edms}
      OIDC_RP_CLIENT_SECRET: ${OIDC_RP_CLIENT_SECRET:?OIDC_RP_CLIENT_SECRET is required}
      # IMPORTANT: Authorization endpoint must be browser-accessible.
      # Override in production with an env var (e.g. https://keycloak.yourdomain.com/...)
      OIDC_OP_AUTHORIZATION_ENDPOINT: ${OIDC_OP_AUTHORIZATION_ENDPOINT:-http://localhost:8081/realms/coffre-fort/protocol/openid-connect/auth}
      # Backchannel endpoints MUST use a base URL consistent with the issuer the browser uses.
      # On Docker Desktop (Windows/Mac), `host.docker.internal` reaches the host-published port.
      # This prevents Keycloak `/userinfo` from rejecting tokens due to base URL/issuer mismatch.
      OIDC_OP_TOKEN_ENDPOINT: ${OIDC_OP_TOKEN_ENDPOINT:-http://host.docker.internal:8081/realms/coffre-fort/protocol/openid-connect/token}
      OIDC_OP_USER_ENDPOINT: ${OIDC_OP_USER_ENDPOINT:-http://host.docker.internal:8081/realms/coffre-fort/protocol/openid-connect/userinfo}
      OIDC_OP_JWKS_ENDPOINT: ${OIDC_OP_JWKS_ENDPOINT:-http://host.docker.internal:8081/realms/coffre-fort/protocol/openid-connect/certs}

    volumes:
      - mayan_media:/var/lib/mayan
      # Mount custom settings for OIDC configuration (now also includes GPG disable)
      - ./docker/mayan/mayan_custom:/var/lib/mayan/mayan_custom:ro
    ports:
      - "8000:8000"
    networks:
      - coffre-fort-network

  # ---------------------------
  # 4) MAYAN WORKERS - FOR PRODUCTION DEPLOYMENT
  # For high-volume deployments, uncomment these workers
  # They provide dedicated queue processing for better throughput
  # 
  # TO ENABLE: 
  # 1. Uncomment worker-fast and worker-slow below
  # 2. Set MAYAN_WORKER_ENABLE: "False" in mayan service above
  # 3. Increase mayan memory limit to 1G (just web server)
  # ---------------------------
  # worker-fast:
  #   image: mayanedms/mayanedms:latest
  #   container_name: coffre-fort-worker-fast
  #   command: run_worker worker_c
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 1G  # Reduced: concurrency=1
  #   environment:
  #     MAYAN_DATABASE_ENGINE: django.db.backends.postgresql
  #     MAYAN_DATABASE_NAME: mayan
  #     MAYAN_DATABASE_USER: mayan
  #     MAYAN_DATABASE_PASSWORD: mayan_password
  #     MAYAN_DATABASE_HOST: postgres
  #     MAYAN_CELERY_BROKER_URL: redis://redis:6379/0
  #     MAYAN_CELERY_RESULT_BACKEND: redis://redis:6379/0
  #     MAYAN_CELERY_WORKER_PREFETCH_MULTIPLIER: 1
  #     MAYAN_QUEUE_LIST: "converter,parsing,ocr,indexing,metadata,uploads,documents_file,documents_version"
  #     MAYAN_SETTINGS_MODULE: "mayan_custom.settings.user_settings"
  #     MAYAN_COMMON_DISABLED_APPS: "mayan.apps.django_gpg,mayan.apps.document_signatures,mayan.apps.signature_captures"
  #     MAYAN_WORKER_C_CONCURRENCY: 1  # KEY: Set to 1 for memory efficiency
  #   depends_on:
  #     - mayan
  #   volumes:
  #     - mayan_media:/var/lib/mayan
  #     - ./docker/mayan/mayan_custom:/var/lib/mayan/mayan_custom:ro
  #   networks:
  #     - coffre-fort-network

  # worker-slow:
  #   image: mayanedms/mayanedms:latest
  #   container_name: coffre-fort-worker-slow
  #   command: run_worker worker_d
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 1G  # Reduced: concurrency=1
  #   environment:
  #     MAYAN_DATABASE_ENGINE: django.db.backends.postgresql
  #     MAYAN_DATABASE_NAME: mayan
  #     MAYAN_DATABASE_USER: mayan
  #     MAYAN_DATABASE_PASSWORD: mayan_password
  #     MAYAN_DATABASE_HOST: postgres
  #     MAYAN_CELERY_BROKER_URL: redis://redis:6379/0
  #     MAYAN_CELERY_RESULT_BACKEND: redis://redis:6379/0
  #     MAYAN_CELERY_WORKER_PREFETCH_MULTIPLIER: 1
  #     MAYAN_QUEUE_LIST: "checkouts_periodic,documents_downloads,documents_exports"
  #     MAYAN_SETTINGS_MODULE: "mayan_custom.settings.user_settings"
  #     MAYAN_COMMON_DISABLED_APPS: "mayan.apps.django_gpg,mayan.apps.document_signatures,mayan.apps.signature_captures"
  #     MAYAN_WORKER_D_CONCURRENCY: 1  # KEY: Set to 1 for memory efficiency
  #   depends_on:
  #     - mayan
  #   volumes:
  #     - mayan_media:/var/lib/mayan
  #     - ./docker/mayan/mayan_custom:/var/lib/mayan/mayan_custom:ro
  #   networks:
  #     - coffre-fort-network

  # ---------------------------
  # 5) KEYCLOAK DATABASE
  # ---------------------------
  keycloak-db:
    image: postgres:15-alpine
    container_name: coffre-fort-keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:?KEYCLOAK_DB_PASSWORD is required}
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    networks:
      - coffre-fort-network

  # ---------------------------
  # 6) KEYCLOAK (optimized)
  # ---------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: coffre-fort-keycloak
    command: start-dev --import-realm
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?KEYCLOAK_ADMIN_PASSWORD is required}
      # Keep Keycloak small for dev on Docker Desktop (avoid exit 137 / OOM kills)
      JAVA_OPTS_APPEND: "-Xms128m -Xmx256m"

      # Dev HTTP setup (avoid Secure cookies on plain HTTP which breaks login POST)
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_URL: "http://localhost:8081"
      KC_HOSTNAME_ADMIN_URL: "http://localhost:8081"
      KC_HOSTNAME_STRICT_HTTPS: "false"

      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:?KEYCLOAK_DB_PASSWORD is required}
      KC_HOSTNAME_STRICT: false

    depends_on:
      keycloak-db:
        condition: service_started

    volumes:
      - ./keycloak/realm-config:/opt/keycloak/data/import

    ports:
      - "8081:8080"
    networks:
      - coffre-fort-network

  # ---------------------------
  # 7) OLLAMA (AI/LLM Service)
  # ---------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: coffre-fort-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - coffre-fort-network
    # GPU Support - NVIDIA GPU (requires nvidia-docker2)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - NVIDIA_VISIBLE_DEVICES=all


  # ---------------------------
  # 8) BACKEND API (Node.js)
  # ---------------------------
  backend:
    build:
      context: ./backend
    container_name: coffre-fort-backend
    environment:
      NODE_ENV: production
      PORT: 5000

      # Redis Configuration (for caching, access grants, WebSocket pub/sub)
      REDIS_HOST: redis
      REDIS_PORT: 6379

      MAYAN_URL: http://mayan:8000
      MAYAN_USERNAME: ${MAYAN_AUTOADMIN_USERNAME:-admin}
      MAYAN_PASSWORD: ${MAYAN_AUTOADMIN_PASSWORD:?MAYAN_AUTOADMIN_PASSWORD is required}

      OLLAMA_URL: http://ollama:11434
      OLLAMA_MODEL: llama3.2:3b

      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: coffre-fort
      KEYCLOAK_CLIENT_ID: coffre-fort-backend
      # KEYCLOAK_CLIENT_SECRET: backend-secret-placeholder
      # NOTE: The backend currently uses public client access or bearer token validation
      # which doesn't strictly require a secret if configured as public/bearer-only.
      # However, if you change it to confidential, you MUST put the secret here.
      KEYCLOAK_CLIENT_SECRET: ""

      # Keycloak Admin API credentials (for user management)
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?KEYCLOAK_ADMIN_PASSWORD is required}

      # Frontend URL for WebSocket CORS
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}

    ports:
      - "5000:5000"

    depends_on:
      - mayan
      - keycloak
      - ollama
      - redis

    networks:
      - coffre-fort-network

  # ---------------------------
  # 9) FRONTEND (React)
  # ---------------------------
  frontend:
    build:
      context: ./frontend
    container_name: coffre-fort-frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - coffre-fort-network

# ---------------------------
# NETWORKS + VOLUMES
# ---------------------------
networks:
  coffre-fort-network:
    driver: bridge

volumes:
  postgres_data:
  mayan_media:
  keycloak_db_data:
  ollama_data:
  redis_data:
